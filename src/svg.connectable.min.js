(function(){function t(t,a){var n={};void 0===a&&(a=t,t={}),e=t.container||this.parent||e;var o=this;if(r=t.markers||this.parent||r,n.source=o,n.target=a,n.type=t.type||"straight",t.connector&&"path"==t.connector.target.type){n.connector=t.connector;var c=n.connector.target.array.valueOf();if("M"!=c[1][0]||"M"!=c[2][0]){var i=n.connector.target.bbox();c.splice(0,0,["M",i.x+i.width/2,i.y],["M",i.x+i.width/2,i.y2]),n.connector.target.plot(c)}}else n.connector=e.path().attr("connectortype","default").fill("none");return n.sourceAttach=t.sourceAttach||"center",n.targetAttach=t.targetAttach||"center",n.color=t.color||"#000000",n.setMarker=function(t,e,r){if(r=r||this,e&&(r.markers=e),t&&"null"!=t)if("default"==t){var t=r.markers.marker(30,30),a="triangle-"+Math.random().toString(16);r.connector.attr("marker-end","url(#"+a+")"),t.attr({id:a,viewBox:"0 0 30 30",refX:"30",refY:"15",markerUnits:"strokeWidth",markerWidth:"12",markerHeight:"15"}),t.path().attr({d:"M 0 0 L 30 15 L 0 30 z"}),r.marker=t,r.marker.fill(r.color)}else r.marker=t;else if(r.marker=null,r.connector.attr("marker-end")){var n=r.connector.attr("marker-end");SVG.get(n.slice(5,n.length-1)).remove(),r.connector.removeClass("marker-end")}return r},n.setMarker(t.marker,t.markers),n.computeConnectorCoordinates=function(t){t=t||this;var e={},r=t.source.bbox(),a=t.target.bbox();if("center"==t.sourceAttach)e.point1=[r.x+r.width/2,r.y+r.height/2];else if("ellipse"==t.source.type){var n=parseFloat(t.source.attr("rx")),o=parseFloat(t.source.attr("ry")),c=t.source.cx(),i=t.source.cy(),h=t.target.cx(),s=t.target.cy(),l=h-c,p=s-i,y=Math.sqrt(l*l+p*p),g=l/y,x=p/y,u=c+n*g,f=i+o*x;e.point1=[u+n/2,f+o/2]}else if("path"==t.source.type){var v=JSON.parse(JSON.stringify(t.source.array.valueOf()));"Z"==v[v.length-1][0]&&v.splice(v.length-1,1);var M=v,d="point2"}else var v=[["M",r.x+r.width/2,r.y],["L",r.x+r.width,r.y+r.height/2],["L",r.x+r.width/2,r.y+r.height],["L",r.x,r.y+r.height/2]],M=v,d="point2";if("center"==t.targetAttach)e.point2=[a.x+a.width/2,a.y+a.height/2];else if("ellipse"==t.target.type){var m=parseFloat(t.target.attr("rx")),k=parseFloat(t.target.attr("ry")),c=t.source.cx(),i=t.source.cy(),h=t.target.cx(),s=t.target.cy(),l=h-c,p=s-i,y=Math.sqrt(l*l+p*p),g=l/y,x=p/y,w=c+(y-m-5)*g,b=i+(y-k-5)*x;e.point2=[w+m/2,b+k/2]}else if("path"==t.target.type){var C=JSON.parse(JSON.stringify(t.target.array.valueOf()));"Z"==C[C.length-1][0]&&C.splice(C.length-1,1);var M=C,d="point1"}else var C=[["M",a.x+a.width/2,a.y],["L",a.x+a.width,a.y+a.height/2],["L",a.x+a.width/2,a.y+a.height],["L",a.x,a.y+a.height/2]],M=C,d="point1";if(!e.point1||!e.point2)if(e.min=Number.MAX_SAFE_INTEGER,e.point1||e.point2){d=e[d];for(var A=0;A<M.length;A++){var L=Math.pow(d[0]-M[A][M[A].length-2],2)+Math.pow(d[1]-M[A][M[A].length-1],2);e.min>L&&(e.min=L,e.point=[M[A][M[A].length-2],M[A][M[A].length-1]])}e.point1?e.point2=e.point:e.point1=e.point}else for(var A=0;A<v.length;A++)for(var O=0;O<C.length;O++){var L=Math.pow(C[O][C[O].length-2]-v[A][v[A].length-2],2)+Math.pow(C[O][C[O].length-1]-v[A][v[A].length-1],2);e.min>L&&(e.min=L,e.point1=[v[A][v[A].length-2],v[A][v[A].length-1]],e.point2=[C[O][C[O].length-2],C[O][C[O].length-1]])}var S=e.point1,N=e.point2;if("curved"==t.type){var F={x:t.source.cx(),y:t.source.cy()},q={x:t.target.cx(),y:t.target.cy()};if(Math.abs(S[0]-F.x)>.5){var E=(S[1]-F.y)/(S[0]-F.x),G=S[1]-E*S[0];if(Math.abs(N[0]-S[0])<Math.abs(N[1]-S[1]))var u=S[0]+(N[0]-S[0])/5,J={x:u,y:E*u+G};else if(Math.abs(S[1]-F.y)>.5)var f=S[1]+(N[1]-S[1])/5,J={x:(f-G)/E,y:f};else var J={x:S[0]+Math.sign(N[0]-S[0])*Math.abs((N[1]-S[1])/5),y:S[1]}}else var J={x:S[0],y:S[1]+(N[1]-S[1])/5};if(Math.abs(N[0]-q.x)>.5){var I=(N[1]-q.y)/(N[0]-q.x),V=N[1]-I*N[0];if(Math.abs(N[0]-S[0])<Math.abs(N[1]-S[1]))var w=N[0]-(N[0]-S[0])/5,P={x:w,y:I*w+V};else if(Math.abs(N[1]-q.y)>.5)var b=N[1]-(N[1]-S[1])/5,P={x:(b-V)/I,y:b};else var P={x:N[0]-Math.sign(N[0]-S[0])*Math.abs((N[1]-S[1])/5),y:N[1]}}else var P={x:N[0],y:N[1]-(N[1]-S[1])/5};var T={x:J.x+(P.x-J.x)/2,y:J.y+(P.y-J.y)/2},W=[["M",S[0],S[1]],["C",J.x,J.y,J.x,J.y,T.x,T.y],["C",P.x,P.y,P.x,P.y,N[0],N[1]]]}else var W=[["M",S[0],S[1]],["L",N[0],N[1]]];return W},o.cons=o.cons||[],o.cons.push(n),n.update=function(){if("default"==n.connector.attr("connectortype"))n.connector.plot(n.computeConnectorCoordinates(n));else{var t=n.connector.target.array.valueOf(),e=n.computeConnectorCoordinates(n),r=[e[0][1],e[0][2]],a=[e[e.length-1][e[e.length-1].length-2],e[e.length-1][e[e.length-1].length-1]],o=Math.sqrt(Math.pow(a[0]-r[0],2)+Math.pow(a[1]-r[1],2)),c=Math.sqrt(Math.pow(t[1][1]-t[0][1],2)+Math.pow(t[1][2]-t[0][2],2)),i=o/c,h=Math.atan((a[1]-r[1])/(a[0]-r[0]));h>0&&a[1]<r[1]?h=Math.PI+h:0>h&&a[1]>r[1]&&a[0]<r[0]&&(h=Math.PI+h);var s={x:r[0]+(a[0]-r[0])/2,y:r[1]+(a[1]-r[1])/2},l=Math.atan((t[1][2]-t[0][2])/(t[1][1]-t[0][1])),p={x:n.connector.target.cx(),y:n.connector.target.cy()},y=[1,0,0,1,s.x-p.x,s.y-p.y],g=y[0],x=y[1],u=y[2],f=y[3],v=y[4],M=y[5],d=Math.sin(-h+l),m=Math.cos(-h+l);v=-g*s.x-u*s.y+v,M=-x*s.x-f*s.y+M,y[0]=g*m+x*d,y[1]=-g*d+x*m,y[2]=u*m+f*d,y[3]=-u*d+m*f,y[4]=m*v+d*M,y[5]=m*M-d*v,y[4]=g*s.x+u*s.y+y[4],y[5]=x*s.x+f*s.y+y[5];var g=1,x=0,u=0,f=1,v=(-g*p.x-u*p.y)*i,M=(-x*p.x-f*p.y)*i,k=[];k[0]=g*i,k[1]=x*i,k[2]=u*i,k[3]=f*i,k[4]=g*p.x+u*p.y+v,k[5]=x*p.x+f*p.y+M;var w=[];w[0]=k[0]*y[0]+k[1]*y[2],w[1]=k[0]*y[1]+k[1]*y[3],w[2]=k[2]*y[0]+k[3]*y[2],w[3]=k[2]*y[1]+k[3]*y[3],w[4]=y[0]*k[4]+y[2]*k[5]+y[4],w[5]=y[1]*k[4]+y[3]*k[5]+y[5],n.connector.transform("matrix",w.join(","))}},n.update(),o.on("dragmove",n.update),a.on("dragmove",n.update),n.setConnectorColor=function(t,e){e=e||this,e.color=t,e.connector.stroke(t),e.marker&&e.marker.fill(t)},n.setConnectorColor(n.color),n.setConnectorAttachment=function(t,e,r){r=r||this,r[t+"Attach"]=e,r.update()},n.setConnector=function(t,r){r=r||this,t&&(r.connector.remove(),"default"==t?(r.connector=e.path().attr("connectortype","default").fill("none"),r.setConnectorColor(r.color)):r.connector=t,r.update())},n.setType=function(t,e){e=e||this,-1!=["straight","curved"].indexOf(t)&&e.type!=t&&(e.type=t,e.update())},n}var e=null,r=null;SVG.extend(SVG.Element,{connectable:t})}).call(this);